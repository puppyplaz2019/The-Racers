<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Racers: Connected Edition</title>
    <style>
        body { margin: 0; background: #222; overflow: hidden; font-family: 'Arial', sans-serif; touch-action: none; }
        #ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; color: white; pointer-events: none; text-shadow: 2px 2px #000; }
        .controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-around; }
        .btn { width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid #fff; }
        canvas { display: block; background: #444; }
    </style>
</head>
<body>

<div id="ui">
    <div>TIME: <span id="time">0.00</span>s</div>
    <div>BEST: <span id="best">0.00</span>s</div>
</div>

<div class="controls">
    <div class="btn" id="left">LEFT</div>
    <div class="btn" id="gas" style="background: rgba(0,255,0,0.3)">GAS</div>
    <div class="btn" id="right">RIGHT</div>
</div>

<script>
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
document.body.appendChild(canvas);
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- HUB CONNECTION ---
const carColor = localStorage.getItem('active_skin_hex') || '#ff0000';
let bestTime = parseFloat(localStorage.getItem('the_racers_best') || 99.99);
document.getElementById('best').innerText = bestTime === 99.99 ? "0.00" : bestTime.toFixed(2);

const car = { x: canvas.width/2, y: canvas.height - 150, w: 40, h: 70, speed: 0, angle: 0 };
const keys = { left: false, right: false, gas: false };

// Touch Handling
function setupTouch(id, key) {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
    el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
}
setupTouch('left', 'left'); setupTouch('right', 'right'); setupTouch('gas', 'gas');

let startTime = Date.now();
let lapFinished = false;

function update() {
    if (lapFinished) return;

    let elapsed = (Date.now() - startTime) / 1000;
    document.getElementById('time').innerText = elapsed.toFixed(2);

    if (keys.gas) car.speed = Math.min(car.speed + 0.2, 8);
    else car.speed *= 0.98;

    if (keys.left) car.angle -= 0.05 * (car.speed / 5);
    if (keys.right) car.angle += 0.05 * (car.speed / 5);

    car.x += Math.sin(car.angle) * car.speed;
    car.y -= Math.cos(car.angle) * car.speed;

    // Check Lap Finish (Crossed Top)
    if (car.y < 0) {
        lapFinished = true;
        finishLap(elapsed);
    }

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Road boundaries
    ctx.strokeStyle = "#fff"; ctx.lineWidth = 5;
    ctx.strokeRect(50, -1000, canvas.width - 100, 2000);

    // Car
    ctx.save();
    ctx.translate(car.x, car.y);
    ctx.rotate(car.angle);
    ctx.fillStyle = carColor; // USES HUB COLOR
    ctx.fillRect(-car.w/2, -car.h/2, car.w, car.h);
    // Windshield
    ctx.fillStyle = "rgba(255,255,255,0.5)";
    ctx.fillRect(-car.w/2 + 5, -car.h/2 + 10, car.w - 10, 15);
    ctx.restore();
}

function finishLap(time) {
    if (time < bestTime) {
        localStorage.setItem('the_racers_best', time);
        alert("NEW WORLD RECORD: " + time.toFixed(2) + "s");
    } else {
        alert("LAP TIME: " + time.toFixed(2) + "s");
    }
    window.location.href = 'index.html'; // Back to Hub
}

update();
</script>
</body>
</html>
