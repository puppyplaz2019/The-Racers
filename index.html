<!DOCTYPE html>
<html>
<head>
    <title>Estate V72 - Hypercar & Melodies</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', sans-serif; }
        #overlay { position: absolute; width: 100%; height: 100%; background: #000; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #ui { position: absolute; top: 10px; left: 10px; color: #fff; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; pointer-events: none; border-left: 4px solid #4facfe; }
        #radioBox { position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.9); padding: 15px; border-radius: 10px; border: 1px solid #4facfe; color: #fff; pointer-events: auto; }
        #tipBox { position: absolute; top: 10px; right: 10px; pointer-events: auto; }
        .btn { padding: 15px 40px; background: linear-gradient(45deg, #4facfe, #00f2fe); border: none; font-weight: bold; cursor: pointer; border-radius: 50px; font-size: 18px; color: #000; transition: 0.2s; }
        .btn:hover { transform: scale(1.05); }
        .station-btn { display: block; width: 100%; margin: 5px 0; padding: 8px; background: #333; border: 1px solid #555; color: white; cursor: pointer; text-align: left; }
        .station-btn:hover { background: #444; border-color: #4facfe; }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>ESTATE V72</h1>
        <p>Hypercar Edition + Music Sequencer</p>
        <button class="btn" onclick="startEngine()">START ENGINE</button>
    </div>

    <div id="ui">
        <b>WASD</b>: Drive | <b>SPACE</b>: Brake<br>
        <b>Model</b>: X-72 Hypercar<br>
        <b>Paint</b>: Midnight Blue Pearl
    </div>

    <div id="tipBox">
        <button class="btn" style="padding: 10px 20px; font-size: 14px;" onclick="tip()">ðŸ’° TIP $100+</button>
    </div>

    <div id="radioBox">
        <b>ðŸŽµ CAR RADIO</b>
        <button class="station-btn" onclick="playSong(1)">1. Faith (Uplifting)</button>
        <button class="station-btn" onclick="playSong(2)">2. Gaming (Retro)</button>
        <button class="station-btn" onclick="playSong(3)">3. Rock (Heavy Bass)</button>
        <button class="station-btn" onclick="stopMusic()">OFF</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, car, carGroup, audioCtx;
        let keyStack = [], playerYaw = 0, speed = 0;
        let intervalId = null; // To control the music loop

        function startEngine() {
            document.getElementById('overlay').style.display = 'none';
            init();
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050510); // Dark night sky
            scene.fog = new THREE.Fog(0x050510, 10, 100);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 8, 15);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // LIGHTS (To make the car shiny)
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(20, 50, 20);
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0x404040));
            
            // "Street Lights"
            const pl = new THREE.PointLight(0x4facfe, 2, 20);
            pl.position.set(0, 10, 0);
            scene.add(pl);

            // GRID FLOOR (Tron Style for Hypercar)
            const grid = new THREE.GridHelper(1000, 100, 0x4facfe, 0x111111);
            scene.add(grid);
            const plane = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({color: 0x000000, roughness: 0.1, metalness: 0.5}));
            plane.rotation.x = -Math.PI/2;
            scene.add(plane);

            createHyperCar();

            window.addEventListener('keydown', e => { if(!keyStack.includes(e.code)) keyStack.push(e.code); });
            window.addEventListener('keyup', e => keyStack = keyStack.filter(k => k !== e.code));

            animate();
        }

        function createHyperCar() {
            carGroup = new THREE.Group();

            // 1. CHASSIS (Low and wide)
            const chassisGeo = new THREE.BoxGeometry(4.5, 0.8, 9);
            const carMat = new THREE.MeshStandardMaterial({
                color: 0x3300aa, // Deep Purple/Blue
                metalness: 0.9,
                roughness: 0.2
            });
            const chassis = new THREE.Mesh(chassisGeo, carMat);
            chassis.position.y = 0.5;
            carGroup.add(chassis);

            // 2. COCKPIT (Black glass dome)
            const cabinGeo = new THREE.BoxGeometry(3, 0.8, 4);
            const glassMat = new THREE.MeshStandardMaterial({color: 0x000000, metalness: 1, roughness: 0});
            const cabin = new THREE.Mesh(cabinGeo, glassMat);
            cabin.position.set(0, 1.3, 0);
            carGroup.add(cabin);

            // 3. SPOILER (Rear Wing)
            const spoilerGeo = new THREE.BoxGeometry(4.5, 0.1, 1.5);
            const spoiler = new THREE.Mesh(spoilerGeo, carMat);
            spoiler.position.set(0, 1.5, 3.5);
            carGroup.add(spoiler);

            // 4. WHEELS (Simple Cylinders)
            const wheelGeo = new THREE.CylinderGeometry(0.8, 0.8, 0.5, 16);
            const wheelMat = new THREE.MeshStandardMaterial({color: 0x111111});
            
            const w1 = new THREE.Mesh(wheelGeo, wheelMat); w1.rotation.z = Math.PI/2; w1.position.set(2.2, 0.5, 2.5); carGroup.add(w1);
            const w2 = new THREE.Mesh(wheelGeo, wheelMat); w2.rotation.z = Math.PI/2; w2.position.set(-2.2, 0.5, 2.5); carGroup.add(w2);
            const w3 = new THREE.Mesh(wheelGeo, wheelMat); w3.rotation.z = Math.PI/2; w3.position.set(2.2, 0.5, -2.5); carGroup.add(w3);
            const w4 = new THREE.Mesh(wheelGeo, wheelMat); w4.rotation.z = Math.PI/2; w4.position.set(-2.2, 0.5, -2.5); carGroup.add(w4);

            scene.add(carGroup);
        }

        // --- MUSIC SEQUENCER ---
        function stopMusic() { if(intervalId) clearInterval(intervalId); }

        function playNote(freq, type, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playSong(station) {
            stopMusic();
            let noteIndex = 0;
            
            if (station === 1) { 
                // FAITH (Slow, Sine wave, Major Scale)
                const melody = [392, 523, 659, 523, 659, 783, 523, 392]; // G C E C E G C G
                intervalId = setInterval(() => {
                    playNote(melody[noteIndex], 'sine', 1);
                    noteIndex = (noteIndex + 1) % melody.length;
                }, 800); // Slow tempo
            } 
            else if (station === 2) { 
                // GAMING (Fast, Square wave, Arpeggios)
                const melody = [440, 0, 440, 0, 880, 0, 660, 550, 440, 880, 990];
                intervalId = setInterval(() => {
                    if(melody[noteIndex] > 0) playNote(melody[noteIndex], 'square', 0.1);
                    noteIndex = (noteIndex + 1) % melody.length;
                }, 150); // Fast tempo
            } 
            else if (station === 3) { 
                // ROCK (Heavy, Sawtooth, Low Bass)
                const melody = [110, 110, 130, 110, 146, 130, 110, 0];
                intervalId = setInterval(() => {
                    if(melody[noteIndex] > 0) playNote(melody[noteIndex], 'sawtooth', 0.3);
                    noteIndex = (noteIndex + 1) % melody.length;
                }, 300); // Medium tempo
            }
        }

        function tip() {
            let amount = prompt("Tip Amount ($):");
            if(parseInt(amount) >= 100) {
                alert("Tip Received! Car paint upgraded to DIAMOND SHINE.");
                carGroup.children[0].material.metalness = 1.0;
                carGroup.children[0].material.roughness = 0.0;
                carGroup.children[0].material.color.setHex(0x00ffff); // Turns Diamond Blue
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            
            const topKey = keyStack[keyStack.length - 1];
            if (topKey === 'KeyW') speed = Math.min(speed + 0.02, 1);
            else if (topKey === 'KeyS') speed = Math.max(speed - 0.02, -0.5);
            else speed *= 0.98; // Friction

            if (topKey === 'KeyA') playerYaw += 0.04;
            if (topKey === 'KeyD') playerYaw -= 0.04;

            carGroup.rotation.y = playerYaw - Math.PI;
            carGroup.position.x -= Math.sin(playerYaw) * speed;
            carGroup.position.z -= Math.cos(playerYaw) * speed;

            camera.position.set(
                carGroup.position.x + Math.sin(playerYaw)*12, 
                carGroup.position.y + 6, 
                carGroup.position.z + Math.cos(playerYaw)*12
            );
            camera.lookAt(carGroup.position);

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
